<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
  <title>‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡¶ø‡¶ï ‡¶ú‡ßç‡¶û‡¶æ‡¶® ¬∑ ‡¶∏‡¶Æ‡ßç‡¶™‡ßÇ‡¶∞‡ßç‡¶£ ‡¶∏‡¶Ç‡¶∏‡ßç‡¶ï‡¶∞‡¶£</title>

  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0,1" />
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Bengali:wght@400;500;600;700;800&family=Amiri:wght@400;700&family=Scheherazade+New:wght@400;700&display=swap" rel="stylesheet">

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b5e42" id="meta-theme-color">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="logo.png">

  <!-- Scripts -->
  <script src="quran-module.js"></script>
  <script src="misconceptions-module.js"></script>

  <style>
    :root {
      --bg-main: #f4f7f6; --bg-surface: #ffffff; --text-primary: #1f2937;
      --text-secondary: #4b5563; --border-color: #e5e7eb; --accent-primary: #0b5e42;
      --accent-hover: #084c35; --shadow-sm: 0 2px 8px rgba(0,0,0,0.08);
      --shadow-md: 0 8px 16px rgba(0,0,0,0.1); --mag-font-size: 16px;
      --mag-3-bg: #e3f2fd; --mag-3-border: #64b5f6;
    }
    [data-theme="dark"] {
      --bg-main: #0f172a; --bg-surface: #1e293b; --text-primary: #f8fafc;
      --text-secondary: #94a3b8; --border-color: #334155; --accent-primary: #10b981;
      --accent-hover: #059669; --shadow-sm: 0 2px 8px rgba(0,0,0,0.4);
      --shadow-md: 0 8px 16px rgba(0,0,0,0.5); --mag-3-bg: #78350f; --mag-3-border: #d97706;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Noto Sans Bengali', sans-serif; background: var(--bg-main); color: var(--text-primary); transition: all 0.4s ease; line-height: 1.6; overflow-x: hidden; padding-bottom: 70px; }
    .container { margin: 0 auto; padding: 0 16px; max-width: 900px; }
    button, input, select { font-family: inherit; outline: none; border: none; }
    header { display: flex; justify-content: space-between; align-items: center; padding: 16px 24px; background: var(--bg-surface); border-bottom: 2px solid var(--accent-primary); border-radius: 0 0 24px 24px; margin-bottom: 24px; box-shadow: var(--shadow-sm); }
    .logo { font-size: 22px; font-weight: 800; display: flex; align-items: center; gap: 8px; color: var(--accent-primary); cursor: pointer; }
    .icon-btn { background: transparent; color: var(--text-secondary); cursor: pointer; padding: 10px; border-radius: 50%; transition: 0.3s; display: flex; align-items: center; justify-content: center; }
    .icon-btn:hover { background: var(--border-color); color: var(--accent-primary); }
    .search-wrapper { display: flex; align-items: center; gap: 8px; background: var(--bg-surface); border: 2px solid transparent; border-radius: 50px; padding: 6px 16px; box-shadow: var(--shadow-md); margin-bottom: 24px; transition: 0.3s; }
    .search-wrapper:focus-within { border-color: var(--accent-primary); transform: translateY(-2px); }
    .search-input { flex: 1; font-size: 16px; background: transparent; color: var(--text-primary); padding: 12px 0; width: 100%; }
    .action-btn { background: var(--accent-primary); color: #fff; padding: 12px 24px; border-radius: 50px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: 0.3s; box-shadow: 0 4px 12px rgba(11,94,66,0.3); }
    .action-btn:hover { transform: translateY(-2px); background: var(--accent-hover); }
    #imageInput { display: none; }
    .vision-indicator { display: none; padding: 6px 12px; background: var(--mag-3-bg); border-radius: 20px; font-size: 12px; font-weight: bold; border: 1px solid var(--mag-3-border); }
    .cat-scroll-container { position: relative; margin-bottom: 24px; }
    .cat-scroll { display: flex; gap: 12px; overflow-x: auto; padding-bottom: 12px; scroll-behavior: smooth; }
    .cat-scroll::-webkit-scrollbar { height: 6px; }
    .cat-scroll::-webkit-scrollbar-track { background: transparent; }
    .cat-scroll::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 10px; }
    .cat-chip { padding: 10px 20px; background: var(--bg-surface); border: 1px solid var(--border-color); border-radius: 50px; cursor: pointer; white-space: nowrap; font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 8px; transition: 0.3s; box-shadow: var(--shadow-sm); }
    .cat-chip.active { background: var(--accent-primary); color: #fff; border-color: var(--accent-primary); }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 16px; padding-bottom: 40px; }
    .q-card { background: var(--bg-surface); padding: 20px; border-radius: 20px; border: 1px solid var(--border-color); text-align: center; cursor: pointer; box-shadow: var(--shadow-sm); transition: 0.3s; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 12px; }
    .q-card:hover { transform: translateY(-6px); border-color: var(--accent-primary); box-shadow: var(--shadow-md); }
    .q-card span.material-symbols-rounded { color: var(--accent-primary); font-size: 36px; transition: transform 0.3s; }
    .loader-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 1000; display: none; flex-direction: column; justify-content: center; align-items: center; color: #fff; }
    .loader-circle { width: 70px; height: 70px; border: 6px solid rgba(255,255,255,0.1); border-top-color: var(--accent-primary); border-radius: 50%; animation: spin 1s infinite; margin-bottom: 24px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .result-area { display: none; margin-top: 20px; padding-bottom: 60px; }
    .mag-section { background: var(--bg-surface); border-radius: 20px; margin-bottom: 20px; padding: 20px; border-left: 8px solid var(--accent-primary); box-shadow: var(--shadow-md); font-size: var(--mag-font-size); line-height: 1.8; }
    .arabic-text { font-family: 'Scheherazade New', serif; font-size: 32px; line-height: 1.8; text-align: right; direction: rtl; padding: 20px; background: rgba(0,0,0,0.04); border-radius: 12px; margin: 16px 0; border: 1px solid var(--border-color); }
    .action-bar { display: flex; flex-wrap: wrap; gap: 12px; margin-top: 32px; padding-top: 20px; border-top: 2px dashed var(--border-color); }
    .btn-outline { padding: 10px 20px; border: 2px solid var(--border-color); border-radius: 50px; background: var(--bg-surface); cursor: pointer; display: inline-flex; align-items: center; gap: 8px; color: var(--text-primary); font-weight: 600; transition: 0.3s; }
    .btn-outline:hover { background: var(--accent-primary); color: #fff; border-color: var(--accent-primary); }
    .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 65px; background: var(--bg-surface); display: flex; justify-content: space-around; align-items: center; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 1000; border-top: 1px solid var(--border-color); }
    .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--text-secondary); text-decoration: none; font-size: 11px; font-weight: 600; cursor: pointer; flex: 1; padding: 8px 0; }
    .nav-item.active { color: var(--accent-primary); }
    .sidebar-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1999; opacity: 0; pointer-events: none; transition: 0.3s; }
    .sidebar-overlay.show { opacity: 1; pointer-events: auto; }
    .sidebar { position: fixed; top: 0; left: 0; bottom: 0; width: 280px; background: var(--bg-surface); z-index: 2000; transform: translateX(-100%); transition: 0.3s; box-shadow: var(--shadow-md); display: flex; flex-direction: column; }
    .sidebar.open { transform: translateX(0); }
    .sb-header { padding: 24px; background: var(--accent-primary); color: #fff; display: flex; flex-direction: column; gap: 12px; }
    .sb-content { padding: 16px; flex: 1; overflow-y: auto; }
    .sb-item { display: flex; align-items: center; gap: 16px; padding: 14px 16px; color: var(--text-primary); border-radius: 12px; font-weight: 600; cursor: pointer; }
    .sb-item:hover { background: var(--bg-main); color: var(--accent-primary); }
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); z-index: 5000; display: none; justify-content: center; align-items: center; }
    .modal-overlay.show { display: flex; }
    .modal-content { background: var(--bg-surface); width: 92%; max-width: 500px; border-radius: 28px; padding: 32px; max-height: 85vh; overflow-y: auto; position: relative; }
    .toast { position: fixed; bottom: -80px; left: 50%; transform: translateX(-50%); background: var(--text-primary); color: var(--bg-surface); padding: 14px 28px; border-radius: 50px; transition: bottom 0.4s; z-index: 6000; font-weight: bold; display: flex; align-items: center; gap: 8px; }
    .toast.show { bottom: 32px; }
    .form-input { width: 100%; padding: 12px 16px; border-radius: 12px; border: 1px solid var(--border-color); background: var(--bg-surface); color: var(--text-primary); font-size: 15px; margin-bottom: 12px;}
    @media (min-width: 768px) {
      .bottom-nav { display: none; }
      body { padding-bottom: 0; padding-left: 260px; }
      .sidebar { transform: translateX(0) !important; width: 260px; border-right: 1px solid var(--border-color); }
      .sidebar-overlay { display: none !important; }
      .menu-btn { display: none !important; }
    }
  </style>
</head>
<body data-theme="light">

  <div class="sidebar-overlay" id="sidebarOverlay" onclick="UI.toggleSidebar()"></div>
  <div class="sidebar" id="sidebar">
    <div class="sb-header">
      <div style="display: flex; align-items: center; gap: 12px;">
        <img src="logo.png" alt="Logo" style="width: 48px; height: 48px; border-radius: 12px; background: white; padding: 2px;">
        <div><div style="font-size: 18px; font-weight: bold;">Islamic Hub</div><div style="font-size: 12px; opacity: 0.9;">v6.0 Complete</div></div>
      </div>
    </div>
    <div class="sb-content">
      <div class="sb-item active" onclick="Logic.showHomeView(); UI.toggleSidebar();"><span class="material-symbols-rounded">home</span> ‡¶Æ‡ßÇ‡¶≤ ‡¶™‡¶æ‡¶§‡¶æ</div>
      <div class="sb-item" onclick="window.location.href='quran.html'"><span class="material-symbols-rounded">menu_book</span> ‡¶ï‡ßÅ‡¶∞‡¶Ü‡¶® ‡¶ì ‡¶π‡¶æ‡¶¶‡¶ø‡¶∏</div>
      <div class="sb-item" onclick="NamazModule.showNamazView(); UI.toggleSidebar();"><span class="material-symbols-rounded">self_improvement</span> ‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ</div>
      <div class="sb-item" onclick="showMisconceptionsView(); UI.toggleSidebar();"><span class="material-symbols-rounded">error</span> ‡¶≠‡ßÅ‡¶≤ ‡¶ß‡¶æ‡¶∞‡¶£‡¶æ</div>
      <div class="sb-item" onclick="UI.openModal('settingsModal'); UI.toggleSidebar();"><span class="material-symbols-rounded">settings</span> ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</div>
      <div class="sb-item" onclick="UI.toggleTheme()"><span class="material-symbols-rounded" id="sbThemeIcon">dark_mode</span> ‡¶•‡¶ø‡¶Æ ‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶®</div>
    </div>
  </div>

  <div class="bottom-nav">
    <div class="nav-item active" onclick="Logic.showHomeView()"><span class="material-symbols-rounded">home</span><span>‡¶π‡ßã‡¶Æ</span></div>
    <div class="nav-item" onclick="window.location.href='quran.html'"><span class="material-symbols-rounded">menu_book</span><span>‡¶ï‡ßÅ‡¶∞‡¶Ü‡¶®</span></div>
    <div class="nav-item" onclick="NamazModule.showNamazView()"><span class="material-symbols-rounded">self_improvement</span><span>‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú</span></div>
    <div class="nav-item" onclick="showMisconceptionsView()"><span class="material-symbols-rounded">error</span><span>‡¶≠‡ßÅ‡¶≤ ‡¶ß‡¶æ‡¶∞‡¶£‡¶æ</span></div>
    <div class="nav-item" onclick="UI.openModal('settingsModal')"><span class="material-symbols-rounded">settings</span><span>‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏</span></div>
  </div>

  <div class="container">
    <header>
      <div class="logo">
        <button class="icon-btn menu-btn" onclick="UI.toggleSidebar()"><span class="material-symbols-rounded">menu</span></button>
        <span class="material-symbols-rounded" style="color:var(--accent-primary);">mosque</span>
        <span>‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡¶ø‡¶ï ‡¶ú‡ßç‡¶û‡¶æ‡¶®</span>
      </div>
      <div style="display:flex; gap:8px;">
        <button class="icon-btn" onclick="window.location.href='quran.html'"><span class="material-symbols-rounded" style="color:#64b5f6;">menu_book</span></button>
        <button class="icon-btn" onclick="UI.toggleTheme()"><span class="material-symbols-rounded" id="themeIcon">dark_mode</span></button>
      </div>
    </header>

    <div style="text-align:center; margin-bottom:32px;">
      <div class="search-wrapper">
        <input type="text" id="searchInput" class="search-input" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶® ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..." autocomplete="off">
        <div id="visionIndicator" class="vision-indicator">üì∑ ‡¶õ‡¶¨‡¶ø ‡¶Ø‡ßÅ‡¶ï‡ßç‡¶§</div>
        <button class="action-btn" onclick="Logic.handleSearch()"><span class="material-symbols-rounded">search</span> ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßÅ‡¶®</button>
      </div>
    </div>

    <div class="cat-scroll-container"><div class="cat-scroll" id="catContainer"></div></div>
    <div class="grid" id="qContainer"></div>

    <div class="result-area" id="namazArea">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
        <button class="btn-outline" onclick="Logic.goBack()"><span class="material-symbols-rounded">arrow_back</span> ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®</button>
        <span style="font-size:20px; font-weight:800; color:var(--accent-primary);">‡¶®‡¶æ‡¶Æ‡¶æ‡¶ú ‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ</span>
      </div>
      <div class="grid" id="namazListContainer"></div>
      <div id="namazDetailContainer" style="display:none; background:var(--bg-surface); padding:20px; border-radius:16px; border:1px solid var(--border-color);"></div>
    </div>

    <div id="misconceptionsContainer" class="container" style="display:none; padding:20px 0;"></div>

    <div class="result-area" id="resultArea">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
        <button class="btn-outline" onclick="Logic.goBack()"><span class="material-symbols-rounded">arrow_back</span> ‡¶´‡¶ø‡¶∞‡ßá ‡¶Ø‡¶æ‡¶®</button>
      </div>
      <div style="font-size:26px; font-weight:800; margin-bottom:24px; color:var(--accent-primary);" id="resQuestionTitle"></div>
      <div id="magazineContent" class="mag-section"></div>
      <div class="action-bar">
        <button class="btn-outline" id="speakBtn" onclick="Logic.speakAns()"><span class="material-symbols-rounded">volume_up</span> ‡¶∂‡ßÅ‡¶®‡ßÅ‡¶®</button>
        <button class="btn-outline" onclick="Logic.copyAns()"><span class="material-symbols-rounded">content_copy</span> ‡¶ï‡¶™‡¶ø</button>
        <span style="font-size:13px; color:var(--text-secondary); background:var(--bg-main); padding:4px 10px; border-radius:20px;" id="aiStats"></span>
      </div>
    </div>
  </div>

  <div class="loader-overlay" id="loader"><div class="loader-circle"></div><div class="loader-text" id="loaderText">‡¶Ö‡¶™‡ßá‡¶ï‡ßç‡¶∑‡¶æ ‡¶ï‡¶∞‡ßÅ‡¶®...</div></div>

  <div class="modal-overlay" id="settingsModal">
    <div class="modal-content">
      <h2 style="margin-bottom:24px;">‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶ì API</h2>
      <form onsubmit="event.preventDefault(); StorageEngine.saveSettings();">
        <input type="password" id="geminiKey" class="form-input" placeholder="Google Gemini API Key">
        <input type="password" id="orKey" class="form-input" placeholder="OpenRouter API Key">
        <input type="password" id="grokKey" class="form-input" placeholder="Grok API Key">
        <div style="display:flex; gap:12px; margin-top:20px;">
          <button type="button" class="btn-outline" onclick="UI.closeModal('settingsModal')">‡¶¨‡¶æ‡¶§‡¶ø‡¶≤</button>
          <button type="submit" class="action-btn">‡¶∏‡¶Ç‡¶∞‡¶ï‡ßç‡¶∑‡¶£ ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>
      </form>
    </div>
  </div>

  <div class="toast" id="toast"><span class="material-symbols-rounded">info</span> <span id="toastMsg">‡¶¨‡¶æ‡¶∞‡ßç‡¶§‡¶æ</span></div>

  <script>
    // Self-healing Error Handler (Factory Reset)
    window.onerror = function(msg, url, line) {
        document.body.innerHTML = `<div style="padding:40px; text-align:center; color:#ef4444; background:#fee2e2; height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center;">
            <h1 style="font-size:40px; margin-bottom:10px;">‚ö†Ô∏è ‡¶∏‡¶ø‡¶∏‡ßç‡¶ü‡ßá‡¶Æ ‡¶è‡¶∞‡¶∞!</h1>
            <p style="font-size:18px; margin-bottom:20px;">‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶¨‡ßç‡¶∞‡¶æ‡¶â‡¶ú‡¶æ‡¶∞‡ßá‡¶∞ ‡¶™‡ßÅ‡¶∞‡¶®‡ßã ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶°‡¶æ‡¶ü‡¶æ‡¶∞ ‡¶ï‡¶æ‡¶∞‡¶£‡ßá ‡¶∏‡¶æ‡¶á‡¶ü‡¶ü‡¶ø ‡¶ï‡ßç‡¶∞‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶ï‡¶∞‡ßá‡¶õ‡ßá‡•§</p>
            <p style="font-size:14px; margin-bottom:30px; color:#991b1b;">Error: ${msg} (Line: ${line})</p>
            <button onclick="localStorage.clear(); sessionStorage.clear(); caches.keys().then(ks => ks.forEach(k => caches.delete(k))); navigator.serviceWorker.getRegistrations().then(rs => rs.forEach(r => r.unregister())); alert('‡¶°‡¶æ‡¶ü‡¶æ ‡¶ï‡ßç‡¶≤‡¶ø‡¶® ‡¶ï‡¶∞‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶è‡¶¨‡¶æ‡¶∞ ‡¶∞‡¶ø‡¶≤‡ßã‡¶° ‡¶¶‡¶ø‡¶®‡•§'); window.location.reload();" style="padding:15px 30px; background:#dc2626; color:white; border:none; border-radius:50px; font-size:18px; font-weight:bold; cursor:pointer; box-shadow:0 4px 15px rgba(220,38,38,0.4);">‡¶´‡ßç‡¶Ø‡¶æ‡¶ï‡ßç‡¶ü‡¶∞‡¶ø ‡¶∞‡¶ø‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</button>
        </div>`;
    };

    const DataModule = (function() {
      let categories = []; let questions =[]; let questionMap = {};
      const loadData = async () => {
        try {
          const res = await fetch('ans.json');
          if (!res.ok) throw new Error();
          const ans = await res.json();
          categories =[{ id: 'all', name: '‡¶∏‡¶¨', icon: 'apps', color: '#6366f1' }];
          for (let catId in ans) {
            const cat = ans[catId];
            if (cat && typeof cat === 'object' && cat.questions) {
              categories.push({ id: catId, name: cat.name || catId, icon: cat.icon || 'help', color: cat.color || '#10b981' });
              cat.questions.forEach(q => {
                if (q && q.q) { questions.push(q); questionMap[q.q] = q; }
              });
            }
          }
        } catch(e) { console.error("Data load failed", e); }
      };
      return { categories, questions, questionMap, loadData };
    })();

    const StorageEngine = {
      saveSettings: () => {
        ['geminiKey','orKey','grokKey'].forEach(id => {
          const v = document.getElementById(id).value.trim();
          if(v) localStorage.setItem(id, v);
        });
        UI.showToast('‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ ‡¶∏‡ßá‡¶≠ ‡¶π‡ßü‡ßá‡¶õ‡ßá');
        UI.closeModal('settingsModal');
      },
      loadSettings: () => {['geminiKey','orKey','grokKey'].forEach(id => {
          const v = localStorage.getItem(id);
          if(v) document.getElementById(id).value = v;
        });
      }
    };

    const AIEngine = {
      run: async (q) => {
        const key = localStorage.getItem('geminiKey');
        if(!key) throw new Error("API Key ‡¶®‡ßá‡¶á! ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏‡ßá ‡¶ó‡¶ø‡ßü‡ßá Key ‡¶¶‡¶ø‡¶®‡•§");
        const prompt = `‡¶§‡ßÅ‡¶Æ‡¶ø ‡¶è‡¶ï‡¶ú‡¶® ‡¶á‡¶∏‡¶≤‡¶æ‡¶Æ‡¶ø‡¶ï ‡¶™‡¶£‡ßç‡¶°‡¶ø‡¶§‡•§ ‡¶™‡ßç‡¶∞‡¶∂‡ßç‡¶®: "${q}"‡•§ ‡¶™‡ßü‡ßá‡¶®‡ßç‡¶ü ‡¶Ü‡¶ï‡¶æ‡¶∞‡ßá ‡¶¶‡¶≤‡¶ø‡¶≤‡¶∏‡¶π ‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ‡ßü ‡¶â‡¶§‡ßç‡¶§‡¶∞ ‡¶¶‡¶æ‡¶ì‡•§`;
        const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${key}`, {
          method: 'POST', headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ contents:[{ parts: [{ text: prompt }] }] })
        });
        const data = await res.json();
        return { text: data.candidates[0].content.parts[0].text, source: 'Gemini AI' };
      }
    };

    const NamazModule = (function() {
      let data = null;
      const load = async () => {
        try { const r = await fetch('namazshikkha.json'); data = await r.json(); } catch(e){}
      };
      const showNamazView = async () => {
        document.getElementById('qContainer').style.display = 'none';
        document.querySelector('.cat-scroll-container').style.display = 'none';
        document.getElementById('resultArea').style.display = 'none';
        document.getElementById('misconceptionsContainer').style.display = 'none';
        document.getElementById('namazArea').style.display = 'block';
        Logic.currentView = 'namaz';
        await load();
        const list = document.getElementById('namazListContainer');
        let html = '';
        if(data && data.prayers) data.prayers.forEach(p => html += `<div class="q-card" onclick="NamazModule.showPrayer('${p.id}')"><h3>${p.name_bn}</h3></div>`);
        list.innerHTML = html || '<h2>‡¶°‡¶æ‡¶ü‡¶æ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶Ø‡¶æ‡ßü‡¶®‡¶ø</h2>';
        list.style.display = 'grid';
        document.getElementById('namazDetailContainer').style.display = 'none';
      };
      const showPrayer = (id) => {
        const p = data.prayers.find(x => x.id === id);
        document.getElementById('namazListContainer').style.display = 'none';
        document.getElementById('namazDetailContainer').innerHTML = `<h2>${p.name_bn}</h2><p>‡¶∞‡¶æ‡¶ï‡¶æ‡¶§: ${p.total_rakats}</p><p>‡¶∏‡¶Æ‡ßü: ${p.time}</p>`;
        document.getElementById('namazDetailContainer').style.display = 'block';
      };
      return { showNamazView, showPrayer };
    })();

    function showMisconceptionsView() {
      document.getElementById('qContainer').style.display = 'none';
      document.querySelector('.cat-scroll-container').style.display = 'none';
      document.getElementById('resultArea').style.display = 'none';
      document.getElementById('namazArea').style.display = 'none';
      const mc = document.getElementById('misconceptionsContainer');
      mc.style.display = 'block';
      Logic.currentView = 'misconception';
      if (typeof window.MisconceptionsModule !== 'undefined') window.MisconceptionsModule.init();
      else mc.innerHTML = '<div style="text-align:center; padding:40px;">‡¶Æ‡¶°‡¶ø‡¶â‡¶≤ ‡¶≤‡ßã‡¶° ‡¶π‡ßü‡¶®‡¶ø</div>';
    }

    const UI = {
      showToast: (msg) => {
        const t = document.getElementById('toast');
        document.getElementById('toastMsg').innerText = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
      },
      toggleTheme: () => {
        const root = document.documentElement;
        const next = root.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
        root.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
        document.getElementById('themeIcon').innerText = next === 'dark' ? 'light_mode' : 'dark_mode';
      },
      openModal: (id) => { document.getElementById(id).style.display = 'flex'; document.getElementById(id).classList.add('show'); },
      closeModal: (id) => { document.getElementById(id).classList.remove('show'); setTimeout(() => document.getElementById(id).style.display='none', 300); },
      toggleSidebar: () => { document.getElementById('sidebar').classList.toggle('open'); document.getElementById('sidebarOverlay').classList.toggle('show'); },
      renderCategories: (active) => {
        document.getElementById('catContainer').innerHTML = DataModule.categories.map(c => `<div class="cat-chip ${c.id===active?'active':''}" onclick="Logic.filterCat('${c.id}')">${c.icon} ${c.name}</div>`).join('');
      },
      renderQuestions: (cat) => {
        const filtered = cat === 'all' ? DataModule.questions.slice(0, 40) : DataModule.questions.filter(q => q.c === cat).slice(0, 40);
        document.getElementById('qContainer').innerHTML = filtered.map(q => `<div class="q-card" onclick="Logic.ask('${q.q.replace(/'/g, "\\'")}')"><h3>${q.q}</h3></div>`).join('');
      }
    };

    const Logic = {
      currentView: 'home', currentAnsText: '', isSpeaking: false,
      showHomeView: () => {
        document.getElementById('resultArea').style.display = 'none';
        document.getElementById('namazArea').style.display = 'none';
        document.getElementById('misconceptionsContainer').style.display = 'none';
        document.querySelector('.cat-scroll-container').style.display = 'block';
        document.getElementById('qContainer').style.display = 'grid';
        Logic.currentView = 'home';
        if(window.speechSynthesis) window.speechSynthesis.cancel();
      },
      filterCat: (id) => { UI.renderCategories(id); UI.renderQuestions(id); Logic.showHomeView(); },
      handleSearch: () => { const q = document.getElementById('searchInput').value.trim(); if(q) Logic.ask(q); },
      ask: async (q) => {
        document.getElementById('searchInput').value = q;
        const off = DataModule.questionMap[q];
        if(off && off.a) {
          Logic.showResult(q, off.a + (off.ref ? `<br><br><b>‡¶§‡¶•‡ßç‡¶Ø‡¶∏‡ßÇ‡¶§‡ßç‡¶∞:</b> ${off.ref}` : ''), '‡¶Ö‡¶´‡¶≤‡¶æ‡¶á‡¶®');
          return;
        }
        document.getElementById('loader').style.display = 'flex';
        try {
          const ans = await AIEngine.run(q);
          Logic.showResult(q, ans.text.replace(/\n/g, '<br>'), ans.source);
        } catch(e) {
          UI.showToast(e.message);
        } finally {
          document.getElementById('loader').style.display = 'none';
        }
      },
      showResult: (q, text, source) => {
        document.getElementById('qContainer').style.display = 'none';
        document.querySelector('.cat-scroll-container').style.display = 'none';
        document.getElementById('resultArea').style.display = 'block';
        document.getElementById('resQuestionTitle').innerText = q;
        document.getElementById('magazineContent').innerHTML = text;
        document.getElementById('aiStats').innerText = `‡¶â‡ßé‡¶∏: ${source}`;
        Logic.currentAnsText = text.replace(/<[^>]*>/g, '');
        Logic.currentView = 'result';
      },
      speakAns: () => {
        if(!window.speechSynthesis) return UI.showToast('‡¶≠‡ßü‡ßá‡¶∏ ‡¶∏‡¶æ‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶®‡ßá‡¶á');
        if(Logic.isSpeaking) { window.speechSynthesis.cancel(); Logic.isSpeaking = false; document.getElementById('speakBtn').innerHTML = '<span class="material-symbols-rounded">volume_up</span> ‡¶∂‡ßÅ‡¶®‡ßÅ‡¶®'; return; }
        const u = new SpeechSynthesisUtterance(Logic.currentAnsText.substring(0, 1000));
        u.lang = 'bn-BD'; u.rate = 0.9;
        u.onend = () => { Logic.isSpeaking = false; document.getElementById('speakBtn').innerHTML = '<span class="material-symbols-rounded">volume_up</span> ‡¶∂‡ßÅ‡¶®‡ßÅ‡¶®'; };
        window.speechSynthesis.speak(u);
        Logic.isSpeaking = true;
        document.getElementById('speakBtn').innerHTML = '<span class="material-symbols-rounded">stop_circle</span> ‡¶•‡¶æ‡¶Æ‡ßÅ‡¶®';
      },
      copyAns: () => { navigator.clipboard.writeText(Logic.currentAnsText); UI.showToast('‡¶ï‡¶™‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá'); },
      goBack: () => {
        if(Logic.currentView !== 'home') { Logic.showHomeView(); }
      }
    };

    window.onload = async () => {
      try {
        await DataModule.loadData();
        StorageEngine.loadSettings();
        UI.renderCategories('all');
        UI.renderQuestions('all');
        if (localStorage.getItem('theme') === 'dark') { document.documentElement.setAttribute('data-theme', 'dark'); document.getElementById('themeIcon').innerText = 'light_mode'; }
      } catch(e) {
        alert("‡¶≤‡ßã‡¶°‡¶ø‡¶Ç ‡¶è ‡¶∏‡¶Æ‡¶∏‡ßç‡¶Ø‡¶æ ‡¶π‡ßü‡ßá‡¶õ‡ßá‡•§ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶∂ ‡¶ï‡ßç‡¶≤‡¶ø‡ßü‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶®‡•§");
      }
    };
  </script>
</body>
</html>
